<%= form_for(block, remote: (remote||false)) do |f| %>
<!-- MODAL HEADER -->
<div class="modal-header">
  <h4 class="modal-title">
    <%= block.block_type.capitalize if block.block_type.present? %> Block
  </h4>
</div>

<!-- MODAL HIDDEN FIELDS -->
<% if action_name == 'new' && params[:page_ids].present? %>
  <input type="hidden" value="<%= params[:page_ids][0].to_i %>" name="block[page_ids][]">
  <input type="hidden" value="<%= @current_website.id %>" name="block[website_id]">
<% end %>
<%= f.check_box :front_page, autocomplete: "off", id: 'front_page_input', class: 'hide' %>

<!-- MODAL BODY -->
<div class="modal-body">

<div class="row">
  <!-- ERROR MESSAGES -->
  <div class="col-sm-12">
    <% if block.errors.any? %>
      <div id="error_explanation" class="form-group">
        <h2><%= pluralize(block.errors.count, "error") %> prohibited this block from being saved:</h2>
        <ul>
        <% block.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
        </ul>
      </div>
    <% end %>
  </div>

  <div class="col-sm-12">
    <% if !Block::TOP_LEVEL_BLOCKS.include?(block.block_type) %>
      <div class="form-group <%= 'hide' if block.id.present? || block.block_type.present? %>" id="block_type">
        <div class="text-center">
          <% Block::TOP_LEVEL_BLOCKS.each do |block_type| %>
              <button type="button" <%= block.id.present? ? 'disabled' : '' %> class="btn btn-lg btn-primary inverse <%= 'active' if block_type == block.block_type %>"
                      id="<%= block_type %>" onClick="setBlockType(this)">
                      <%= block_type.capitalize %></button>
          <% end %>
        </div>
        <div class="form-group hide">
          <label>Block Type</label>
          <%= f.select :block_type, Block::BLOCK_TYPES.collect {|x| [x.humanize, x]}, {:include_blank => "-- Block Type --"}, :class => 'form-control' %>
        </div>
      </div>
      <div class="form-group hide" id="block">
        <div class="dt-label">
          Container Block
        </div>
        <div>
          <%= f.select :block_id, block.parent_block_options.collect {|x| [x.name.present? ? "#{x.name} (#{x.blocks.count})" : "Block id: #{x.id} (#{x.blocks.count})", x.id]}, {:include_blank => "-- Select a Container --"}, :class => 'form-control' %>
        </div>
      </div>
      <div class="form-group" id="category">
        <div>
          <label>Category</label>
          <%= f.select :category_id, @current_website.categories.collect {|x| [x.name.present? ? "#{x.name} (#{x.pages.try(:count)})" : "Block id: #{x.id} (#{x.pages.try(:count)})", x.id]}, {:include_blank => "-- Select a Category --"}, :class => 'form-control' %>
        </div>
      </div>
      <div class="form-group" id="form_list">
        <div>
          <label>Form</label>
          <%= f.select :form_id, @current_website.forms.collect {|x| [x.name, x.id]}, {:include_blank => "-- Select a Form --"}, :class => 'form-control' %>
          <div class="text-right">
            <%= link_to 'Manage forms', forms_path %>
          </div>
        </div>
      </div>
      <div class="form-group" id="columns">
        <div>
          Max Columns
        </div>
        <div>
          <%= f.select :columns, [1,2,3,4], {}, :class => 'form-control' %>
        </div>
      </div>
    <% end %>
    <div class="form-group" id="location">
      <div class="dt-label">
        Location
      </div>
      <div id="location">
        <%= f.select :location, Block::REGIONS, {:include_blank => "-- Select a location --"}, :class => 'form-control' %>
      </div>
    </div>
    <div class="form-group">
      <div class="dt-label">
        Block position
      </div>
      <div id="position">
        <%= f.select :position, (1..20).to_a, {},class: 'form-control' %>
      </div>
    </div>
    <script type="text/javascript">
      var default_options = <%= Block::REGIONS.to_json.html_safe %>;
      var main_options = <%= Block::CONTENT_REGIONS.to_json.html_safe %>;
      var location_value = '<%= block.location %>';

      function set_options(){
        // $('#block').hide();
        $('#columns').hide();
        $('#location').hide();
        $('#category').hide();
        $('#form_list').hide();

        if(['container','custom','category_list', 'form'].indexOf($('#block_type select').val()) > -1){
          $('#location').show();
          $('#location select').empty();
          if(<%= params[:page_ids].present? %>){
            default_options.forEach(function(option){
              $('#location select').append("<option>" + option + "</option>");
            });
          }else{
            main_options.forEach(function(option){
              $('#location select').append("<option>" + option + "</option>");
            });
          }

        }
        if($('#block_type select').val() == 'sub_block'){
          $('#block').show();
        };
        if($('#block_type select').val() == 'container'){
          $('#columns').show();
        }
        if($('#block_type select').val() == 'category_list'){
          $('#category').show();
        }
        if($('#block_type select').val() == 'form'){
          $('#form_list').show();
        }
        $('#location select').val(location_value).change();
      }

      function hide_navigation_fields(){
        var name_about = $('#name, #about');
        if($('#block_type select').val() == 'navigation'){
          name_about.hide();
        }else{
          name_about.show();
        }
      }
      $('#block_type select').change(set_options);
      $('#block_type select').change(hide_navigation_fields);
      $('#block_type select').change();
      function setBlockType(div){
        $('#block_type select').val(div.id).change();
        $('#block_type button.active').removeClass('active');
        $(div).addClass('active');
      }
    </script>

  <!-- IMAGE UPLOAD -->

  <% if @block.id.present? %>
    <div class="form-group" id="image_block">
      <div class="well text-center dropzone" id="fileupload_<%= dom_id(block) %>_dropzone">
        <span class="btn btn-primary fileinput-button">
            <!-- The file input field used as target for the file upload widget -->
            <span><i class="fa fa-photo"></i> Upload image</span>
            <input id="fileupload_<%= dom_id(block) %>" type="file" name="asset">
        </span>
      </div>
      <div class="form-group">
        <!-- The container for the uploaded files -->
        <div id="files" class="files"></div>
        <!-- The global progress bar -->

        <div id="progress" class="hide progress">
            <div class="progress-bar progress-bar-success"></div>
        </div>

        <div id="images">
          <%= render 'images/image', image: block.image if block.image.present? %>
        </div>
      </div>


      <div id="edit_image_script">
        <%# link_to 'Remove Logo', logo_path(@website.logo), method: :delete, class: 'btn btn-danger', remote: true if @website.logo.asset.present? %>
        <%= render 'blocks/edit_image_script', block: block%>
      </div>
      <div>
        BG Color
      </div>
      <div id="bg_color" class="form-group">
        <%= f.text_field :bg_color, class: 'form-control color', id: 'color', name: 'block[bg_color]' %>
      </div>
      <br/>
    </div>
  <% end %>

  <script type="text/javascript">
    $("#color").colorpicker();
  </script>

  <% if !Block::SYSTEM_BLOCK_TYPES.include?(block.block_type) %>
    <div class="">

      <div class="form-group" id="name">
        <%= f.text_field :name, class: 'form-control', placeholder: 'Title' %>
      </div>

      <div class="form-group" id="about">
        <%= f.text_area :about, class: 'form-control', rows: '6', placeholder: 'Description' %>
        <input name="image[asset]" data-attachable-id="<%=@current_website.id%>" data-attachable-type="Website" type="file" id="tiny_block_upload" class="hidden" onchange="">

        <script type="text/javascript">
          // timyMceSetup('#block_about', '/websites/<%=@current_website.id%>/stylesheet.css', '#tiny_block_upload');
        </script>
      </div>
      <div class="about_bottom"></div>
      <div class="dt-label">
        Text Align
      </div>
      <div class="form-group" id="text_align">
        <%= f.select :text_align, Block::TEXT_ALIGN_OPTIONS, {}, :class => 'form-control' %>
      </div>
    </div>

  <% end %>

  <% if !Block::SYSTEM_BLOCK_TYPES.include?(block.block_type) %>
    <div class="">

      <div class="dt-label">
        Link
      </div>
      <div class="form-group">
        <div class="row">
          <div class="col-sm-6">
            <%= f.text_field :link, class: 'form-control', placeholder: 'http://example.com or /pages/about' %>
          </div>
          <div class="col-sm-6">
            <%= f.text_field :link_text, class: 'form-control', placeholder: 'Learn more' %>
          </div>
        </div>
      </div>
    </div>
  <% end %>
  </div>
</div>
</div>
<div class="modal-footer">
  <div class="text-center">
    <%= f.hidden_field :website_id, value: block.website_id || @current_website.id %>
    <%= f.submit 'Save & Close', class: 'btn btn-success' %>
    <button type="submit" name="block[continue_edit]" value='true' class="btn btn-success">
      Save & Continue
    </button>
  </div>
</div>

<% end %>
