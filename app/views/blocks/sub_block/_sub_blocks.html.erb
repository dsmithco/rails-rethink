<% if block.blocks.present? %>
  <div class="row block-sortable-connect" data-block-id="<%= block.id %>" data-update-url="/blocks/sort.js?block_id=<%= block.id %>" id="<%= dom_id(block) %>">
    <% block.blocks.each_with_index do |sub_block, index| %>
      <div data-id="<%= sub_block.id %>" style="position: relative;" class="block-group <%= 'can_edit' if can? :update, block %> block-group-<%= block.id %>-<%= index / block.column_config.count %> text-<%= sub_block.text_align %> col-md-<%= block.column_config[index % block.column_config.count] %>" id="<%= dom_id(sub_block) %>">
        <div class="block-group-<%=block.id%> block-container">
          <%= render 'blocks/block', block: sub_block %>
        </div>
      </div>
      <script type="text/javascript">
        setTimeout(function () {
          $('.block-group-<%= block.id %>-<%= index / block.columns %>').matchHeight();
        }, 100);
      </script>
    <% end %>
  </div>
  <% if can? :edit, block %>
    <style media="screen">
      .ui-sortable-helper {
        padding: 0 !important;
        border-radius: 0px;
        min-height: 0px;
        margin: 0px;
      }
    </style>

    <script type="text/javascript">
      $( ".block-sortable-connect" ).sortable();
      $( ".block-sortable-connect" ).sortable({
        handle: '.sub_block-handle',
        tolerance: 'pointer',
        placeholder: "ui-state-highlight-block",
        forcePlaceholderSize: true,
        forceHelperSize: true,
        connectWith: ".block-sortable-connect",
        update: function( event, ui ) {
          return $.post($(this).data('update-url'), $(this).sortable('serialize'));
        }
      });

    </script>
  <% end %>
<% end %>
