<fieldset>
  <legend>
    Hero Images
    <span class="btn btn-success btn-sm fileinput-button">
        <span>Upload Hero Image</span>
        <!-- The file input field used as target for the file upload widget -->
        <input id="fileupload1" type="file" name="hero_image[asset]" multiple>
    </span>
  </legend>
  <div>
    <!-- The container for the uploaded files -->
    <div id="files" class="files"></div>
    <!-- The global progress bar -->
    <div id="progress" class="hide progress form-group">
        <div class="progress-bar progress-bar-success"></div>
    </div>
    <%# link_to 'Remove Logo', logo_path(@website.logo), method: :delete, class: 'btn btn-danger', remote: true if @website.logo.asset.present? %>
  </div>
  <div class="row" id="hero_images">
    <div class="clearfix" ng-if="$index % 3 == 0">
    </div>
    <div id="sortable_heros">
      <% @website.hero_images.each do |hero| %>
        <span class="col-sm-12" data-id="<%=hero.id%>">
          <div class="hero_image_<%=hero.id%>">
            <div class="panel panel-default">
              <div class="panel-body">
                <%= form_for(hero, remote: true, id: "#{dom_id(hero)}") do |f|%>
                  <div class="row">
                    <div class="col-sm-4">
                      <div data-as-sortable-item-handle>
                        <img src="<%=hero.medium%>" alt="<%=hero.name%>" />
                        <label class="label label-success <%= @website.hero_images.first != hero ? 'hide':''%>">Active</label>
                      </div>
                    </div>
                    <div class="col-sm-8">
                      <div class="row">
                        <div class="col-sm-9">
                          <div class="form-group">
                            <%= f.text_field :name, class: 'form-control', placeholder: 'Title' %>
                          </div>
                        </div>
                        <div class="col-sm-3">
                          <%= link_to 'Remove', hero_image_path(hero), class: 'btn btn-danger btn-block', method: :delete, remote: true, data: {confirm: "Delete Hero #{hero.name}", disable_with: 'Removing...'}%>
                        </div>
                      </div>
                        <div class="form-group">
                          <%= f.text_field :about, class: 'form-control', placeholder: 'Subtitle' %>
                        </div>
                        <div class="row">
                          <div class="col-sm-6">
                            <div class="form-group">
                              <%= f.text_field :link, class: 'form-control', placeholder: 'Link' %>
                            </div>
                          </div>
                          <div class="col-sm-6">
                            <div class="form-group">
                              <%= f.text_field :link_text, class: 'form-control', placeholder: 'Link text' %>
                            </div>
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-sm-6 submit_button hide">
                            <%= f.submit 'Save', class: 'btn btn-success'%>
                          </div>

                        </div>
                    </div>

                  </div>
                  <script type="text/javascript">
                    $("form").keyup(function(){
                      $(this).find('.submit_button').removeClass('hide');
                    });
                  </script>
                <% end %>
              </div>

            </div>
          </div>
        </span>
      <% end %>
    </div>
    <script type="text/javascript">
      $( "#sortable_heros" ).sortable();
      $( "#sortable_heros" ).sortable({
        placeholder: "ui-state-highlight",
        tolerence: 'intersect'
      });
      $( "#sortable_heros" ).on( "sortupdate", function( event, ui ) {
        // console.log(event);
        var id,url,position,item;
        id = ui.item.context.dataset.id;
        url = "/hero_images/" + id + ".js";
        position = $(ui.item).index() + 1;
        item = {'hero_image':{'position': position}};
        $.ajax({
            url: url,
            type: 'PUT',
            data: item,
            success: function(result) {
                // Do something with the result
            }
        });
      });
    </script>
    <style>
      #sortable_heros {list-style-type: none; margin: 0; padding: 0;}
      #sortable_heros li {margin: 0 5px 5px 5px;padding: 5px;font-size: 1.2em;height: 1.5em;}
      html>body #sortable_heros li {height: 1.5em;line-height: 1.2em;}
      .ui-state-highlight {height: 200px;border-radius: 4px;border: 1px dashed #ccc;line-height: 1.2em;width: 100%;display: block;clear: both;margin-bottom: 20px;}
    </style>
  </div>

</fieldset>

<script type="text/javascript">

  /*jslint unparam: true */
  /*global window, $ */
  $(function () {
    'use strict';
    // Change this to the location of your server-side upload handler:
    $('#fileupload1').fileupload({
      dataType: 'script',
      url: '/hero_images',
      type: 'POST',
      multipart: true,
      formData: {"hero_image[attachable_id]": <%= @website.id %>, "hero_image[attachable_type]": 'Website'},
      add: function(e, data) {
        var file, types;
        types = /(\.|\/)(gif|jpe?g|png)$/i;
        file = data.files[0];
        if (types.test(file.type) || types.test(file.name)) {
          data.context = $('<div>' + file.name + '</div>');
          $('#files').append(data.context);
          return data.submit();
        } else {
          return alert(file.name + " is not a gif, jpeg, or png image file");
        }
      },
      progress: function(e, data) {
        var progress;
        if (data.context) {
          progress = parseInt(data.loaded / data.total * 100, 10);
          $('.progress').removeClass('hide');
          return $('.progress-bar').css('width', progress + '%');
          console.log(progress)
        }
      },
      done: function(e, data){
        if (data.context) {
          console.log('done')
          return data.context.remove();
        }
      }
    });
  });
</script>
